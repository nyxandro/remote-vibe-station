services:
  proxy:
    image: traefik:v3.4
    # Reverse proxy, TLS и маршрутизация
    command:
      - "--configFile=/etc/traefik/traefik.yml"
      - "--certificatesresolvers.le.acme.email=${TLS_EMAIL}"
      - "--certificatesresolvers.le.acme.storage=/acme/acme.json"
      - "--certificatesresolvers.le.acme.httpchallenge.entrypoint=web"
    ports:
      - "${PROXY_HTTP_PORT:-80}:80"
      - "${PROXY_HTTPS_PORT:-443}:443"
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock:ro
      - ./infra/traefik/traefik.yml:/etc/traefik/traefik.yml:ro
      - ./infra/traefik/dynamic:/etc/traefik/dynamic:ro
      - ./infra/traefik/acme.json:/acme/acme.json
    networks:
      - public
      - internal

  backend:
    build:
      context: ./services/backend
      dockerfile: Dockerfile
    # Middleware: OpenCode API, Telegram webhook, управление Docker
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ADMIN_IDS=${ADMIN_IDS}
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
      - PUBLIC_DOMAIN=${PUBLIC_DOMAIN}
      - PROJECTS_ROOT=${PROJECTS_ROOT}
      - OPENCODE_CONFIG_DIR=/opencode-config
      - OPENCODE_SERVER_URL=${OPENCODE_SERVER_URL}
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD}
      - OPENCODE_SERVER_USERNAME=${OPENCODE_SERVER_USERNAME}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ${PROJECTS_ROOT}:${PROJECTS_ROOT}
      # Shared OpenCode state volume (projects/sessions/messages).
      - opencode_data:/opencode-data
      - opencode_config:/opencode-config
      - backend_data:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.backend.rule=Host(`${PUBLIC_DOMAIN}`) && (PathPrefix(`/api`) || PathPrefix(`/events`))"
      - "traefik.http.routers.backend.entrypoints=websecure"
      - "traefik.http.routers.backend.tls.certresolver=le"
      - "traefik.http.services.backend.loadbalancer.server.port=3000"
    networks:
      - internal
      - public
    healthcheck:
      test: ["CMD", "curl", "-fsS", "http://localhost:3000/api/projects"]
      interval: 10s
      timeout: 3s
      retries: 30
      start_period: 10s

  bot:
    build:
      context: ./services/bot
      dockerfile: Dockerfile
    # Telegram webhook обработчик
    environment:
      - TELEGRAM_BOT_TOKEN=${TELEGRAM_BOT_TOKEN}
      - ADMIN_IDS=${ADMIN_IDS}
      - BACKEND_URL=http://backend:3000
      - PUBLIC_BASE_URL=${PUBLIC_BASE_URL}
      - OPENCODE_PUBLIC_BASE_URL=${OPENCODE_PUBLIC_BASE_URL:?OPENCODE_PUBLIC_BASE_URL must be set}
    volumes:
      - bot_data:/app/data
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.bot.rule=Host(`${PUBLIC_DOMAIN}`) && Path(`/bot/webhook`)"
      - "traefik.http.routers.bot.entrypoints=websecure"
      - "traefik.http.routers.bot.tls.certresolver=le"
      - "traefik.http.routers.bot-auth.rule=Host(`${OPENCODE_PUBLIC_DOMAIN:?OPENCODE_PUBLIC_DOMAIN must be set}`) && PathPrefix(`/opencode-auth`)"
      - "traefik.http.routers.bot-auth.entrypoints=websecure"
      - "traefik.http.routers.bot-auth.tls.certresolver=le"
      - "traefik.http.routers.bot-auth.middlewares=noindex-headers@file"
      - "traefik.http.services.bot.loadbalancer.server.port=3001"
    networks:
      - internal
      - public

  miniapp:
    build:
      context: ./services/miniapp
      dockerfile: Dockerfile
    # Mini App для управления
    ports:
      - "${MINIAPP_HOST_PORT:-4173}:4173"
    labels:
      - "traefik.enable=true"
      - "traefik.http.routers.miniapp.rule=Host(`${PUBLIC_DOMAIN}`) && PathPrefix(`/miniapp`)"
      - "traefik.http.routers.miniapp.entrypoints=websecure"
      - "traefik.http.routers.miniapp.tls.certresolver=le"
      - "traefik.http.services.miniapp.loadbalancer.server.port=4173"
    networks:
      - internal
      - public

  opencode:
    build:
      context: ./services/opencode
      dockerfile: Dockerfile
    # OpenCode server mode
    command: ["opencode", "serve", "--hostname", "0.0.0.0", "--port", "4096"]
    environment:
      - OPENCODE_SERVER_PASSWORD=${OPENCODE_SERVER_PASSWORD}
      - OPENCODE_SERVER_USERNAME=${OPENCODE_SERVER_USERNAME}
    volumes:
      - ${PROJECTS_ROOT}:${PROJECTS_ROOT}
      # Persist OpenCode state (projects/sessions/messages) in a named volume.
      - opencode_data:/root/.local/share/opencode
      # Persist global OpenCode config (AGENTS, agents, skills, plugins, opencode.json).
      - opencode_config:/root/.config/opencode
    labels:
      - "traefik.enable=true"
      - "traefik.docker.network=public"
      - "traefik.http.routers.opencode.rule=Host(`${OPENCODE_PUBLIC_DOMAIN:?OPENCODE_PUBLIC_DOMAIN must be set}`)"
      - "traefik.http.routers.opencode.entrypoints=websecure"
      - "traefik.http.routers.opencode.tls.certresolver=le"
      - "traefik.http.routers.opencode.middlewares=opencode-forward-auth@file,noindex-headers@file"
      - "traefik.http.services.opencode.loadbalancer.server.port=4096"
    networks:
      - internal
      - public

networks:
  public:
    name: public
    driver: bridge
  internal:
    driver: bridge

volumes:
  opencode_config:
  backend_data:
  opencode_data:
  bot_data:
