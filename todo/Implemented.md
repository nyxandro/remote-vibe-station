# Implemented

1. 2026-02-24 - Реализовано голосовое управление через Telegram bot с Groq Whisper: бот принимает voice-сообщения, валидирует лимиты (`<=25 MB`, положительная длительность), отправляет аудио в `POST https://api.groq.com/openai/v1/audio/transcriptions` (модели `whisper-large-v3-turbo`/`whisper-large-v3`), показывает динамический статус распознавания и пересылает распознанный текст в обычный prompt pipeline. Добавлена настройка в Mini App (`6. Голосовое управление`): ввод Groq API key + выбор модели + сохранение в backend preferences store. Добавлены новые backend endpoints для miniapp/bot доступа к voice-настройкам и тесты для backend/bot/miniapp. Файлы: `services/bot/src/main.ts`, `services/bot/src/voice-control.ts`, `services/bot/src/tests/voice-control.test.ts`, `services/backend/src/telegram/telegram.controller.ts`, `services/backend/src/telegram/preferences/telegram-preferences.types.ts`, `services/backend/src/telegram/preferences/telegram-preferences.service.ts`, `services/backend/src/telegram/preferences/tests/telegram-preferences.service.test.ts`, `services/miniapp/src/hooks/use-voice-control-settings.ts`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/WorkspaceTabsContent.tsx`, `services/miniapp/src/App.tsx`, `services/miniapp/src/types.ts`, `services/miniapp/src/components/tests/settings-tab.test.tsx`, `docs/TELEGRAM_VOICE_CONTROL.md`. Проверить: в Telegram voice-сообщение распознается и уходит агенту, а при отсутствии настройки/ошибке транскрибации отображается сообщение `Для перевода речи в текст настройте Groq API.`

1. 2026-02-24 - Выполнена англоязычная локализация Mini App: переведены все русскоязычные строки UI и связанные тестовые ожидания в Settings/Projects/Diff Preview, а также README miniapp. Обновлены файлы: `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/ProjectsTab.tsx`, `services/miniapp/src/components/DiffPreviewScreen.tsx`, `services/miniapp/src/components/tests/settings-tab.test.tsx`, `services/miniapp/src/components/tests/projects-tab.test.tsx`, `services/miniapp/README.md`. Проверить: в Mini App отсутствуют русские подписи/сообщения, все элементы интерфейса и модальные действия отображаются на английском.

1. 2026-02-24 - Убрана функция управления Skills/Plugins через Mini App Settings: секции `Skills` и `Plugins` удалены из UI, из payload `settings/overview` исключены поля `skills/plugins`, а типы `OpenCodeSettingsKind` и `OpenCodeSettingsOverview` очищены от `skill/plugin` для fail-fast запрета этих операций через settings API. Также обновлены номера секций в Settings и тесты. Файлы: `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/tests/settings-tab.test.tsx`, `services/miniapp/src/types.ts`, `services/backend/src/opencode/opencode-settings.service.ts`, `services/backend/src/opencode/tests/opencode-settings.service.test.ts`. Проверить: в Mini App нет аккордеонов Skills/Plugins, backend `/api/opencode/settings/overview` не содержит `skills/plugins`.

1. 2026-02-24 - Исправлен баг автопереоткрытия редактора в Mini App Settings: при повторном входе во вкладку Settings больше не открывается автоматически ранее активный файл (`AGENTS.md` и др.) из stale `activeFile`; модалка теперь открывается только на обновление выбора файла после маунта вкладки. Добавлены UI-тесты на отсутствие авто-открытия при initial mount и на открытие по обновлению `activeFile`. Файлы: `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/tests/settings-tab.test.tsx`. Проверить: после создания/редактирования файла и переходов по вкладкам Settings больше не открывает редактор сам по себе.

1. 2026-02-24 - Обновлен UX блока правил в Mini App Settings: если файл правил не создан, он больше не отображается как открываемый элемент списка (для `Global AGENTS.md` и `Project AGENTS.md` показывается только кнопка создания), чтобы убрать вводящие в заблуждение пункты. Добавлен UI-тест на скрытие отсутствующих rule-файлов. Файлы: `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/tests/settings-tab.test.tsx`. Проверить: в `1. Правила агента` отсутствующие AGENTS-файлы не видны в списке и доступны только через кнопки `Создать ...`.

1. 2026-02-24 - Улучшено стартовое сообщение Telegram-бота (`/start`): вместо статичной шпаргалки бот теперь показывает информативную сводку из backend (`/api/telegram/startup-summary`) — текущий выбранный проект, сводку незакоммиченных изменений (если есть), активный режим (model/agent/thinking) и актуальный список доступных команд. Для этого добавлен новый admin endpoint в TelegramController, formatter/loader в bot и покрытие тестами (unit + e2e на backend, unit на bot formatter). Файлы: `services/backend/src/telegram/telegram.controller.ts`, `services/backend/src/telegram/tests/telegram.controller.test.ts`, `services/backend/src/telegram/tests/telegram.controller.e2e.test.ts`, `services/bot/src/start-summary.ts`, `services/bot/src/main.ts`, `services/bot/src/tests/start-summary.test.ts`. Проверить: после `/start` приходит сводка с проектом, git-изменениями, режимом и списком команд.

1. 2026-02-24 - Убрано дублирование команд режима в Telegram: удален alias `/models`, оставлен единый вход `/mode` (одинаковое поведение не дублируется в меню и handler). Обновлены backend/bot каталоги команд и тесты. Файлы: `services/bot/src/mode-control.ts`, `services/bot/src/telegram-commands.ts`, `services/bot/src/tests/telegram-commands.test.ts`, `services/backend/src/telegram/telegram-command-catalog.service.ts`, `services/backend/src/telegram/tests/telegram-command-catalog.service.test.ts`. Проверить: в меню Telegram больше нет `/models`, `/mode` открывает панель выбора модели/агента как раньше.

1. 2026-02-24 - Обновлен Telegram bridge динамических команд OpenCode: из каталога, отдаваемого в `GET /api/telegram/commands`, исключены `init` и `review`, чтобы эти команды не публиковались в Telegram меню и не резолвились через lookup в боте. Добавлен unit-тест на blacklist и обновлены существующие тесты нормализации. Файлы: `services/backend/src/telegram/telegram-command-catalog.service.ts`, `services/backend/src/telegram/tests/telegram-command-catalog.service.test.ts`. Проверить: в Telegram `getMyCommands` больше не содержит `init`/`review`, при этом остальные динамические команды (например `testcommand`) продолжают публиковаться.

1. 2026-02-24 - Добавлен промежуточный каталог-команд для Telegram: backend теперь собирает локальные команды бота и динамические команды OpenCode в единую Telegram-совместимую структуру (`command/description`) с lookup-словарем алиасов (`review_changes -> review-changes`) и отдает ее через `GET /api/telegram/commands`; bot переведен на потребление этого каталога без локального merge. Также добавлены контрактные тесты на уровень контроллера: unit-тест формы ответа (`commands + lookup`) и HTTP e2e-тест маршрута с проверкой guard (`x-admin-id`) и сериализованного JSON-контракта, включая сценарий невалидного `x-admin-id` (не входит в `ADMIN_IDS`). Для UX совместимости добавлен локальный alias `/models` (в меню и handler) как быстрый вход в селектор режима, чтобы команда не падала с `Неизвестная команда`. Файлы: `services/backend/src/telegram/telegram-command-catalog.service.ts`, `services/backend/src/telegram/tests/telegram-command-catalog.service.test.ts`, `services/backend/src/telegram/tests/telegram.controller.test.ts`, `services/backend/src/telegram/tests/telegram.controller.e2e.test.ts`, `services/backend/src/telegram/telegram.controller.ts`, `services/backend/src/app.module.ts`, `services/bot/src/main.ts`, `services/bot/src/telegram-commands.ts`, `services/bot/src/mode-control.ts`, `services/bot/src/tests/telegram-commands.test.ts`. Проверить: в Telegram меню видно объединенный список команд, `/models` и `/mode` открывают одинаковое меню выбора модели/агента, slash-команды с дефисом выполняются через алиас с underscore, endpoint `/api/telegram/commands` стабильно возвращает `commands` и `lookup`, без `x-admin-id` и с чужим `x-admin-id` возвращает 401.

1. 2026-02-12 - Добавлена фильтрация «шумных» terminal-команд в Telegram runtime-stream: backend bridge теперь подавляет прогресс-сообщения для версионных probe-команд (`node -v`, `npm -v`, `pnpm/yarn/bun -v`, `python --version`), чтобы в чате оставались только полезные команды выполнения. Добавлен unit-тест на отсутствие enqueue для `node -v` (`services/backend/src/telegram/outbox/telegram-opencode-runtime-bridge.service.ts`, `services/backend/src/telegram/outbox/tests/telegram-opencode-runtime-bridge.test.ts`). Проверить: после рабочих команд больше не приходят отдельные terminal-карточки с `node -v`.

1. 2026-02-12 - Устранен дублирующийся поток terminal-progress в Telegram на стороне bot delivery: replace-сообщения (`mode=replace`) теперь отправляются без `reply keyboard` по умолчанию (оставляется только inline markup, если он явно задан), чтобы Telegram позволял `editMessageText` в том же сообщении; добавлен unit-тест на отсутствие `reply_markup` для replace-progress (`services/bot/src/outbox-worker.ts`, `services/bot/src/tests/outbox-worker.test.ts`). Проверить: во время выполнения `bash` в Telegram одна карточка команды обновляется, а не создаются новые сообщения.

1. 2026-02-12 - Исправлена еще одна причина дублей live-terminal сообщений в Telegram: в runtime bridge заменен механизм стабилизации `progressKey` для `bash` — теперь replace-слот привязывается к `session + command`, а не к `part.id/callID`, потому что runtime может ротировать оба идентификатора между incremental-апдейтами. Добавлен unit-тест на churn `part.id` и `callID` в одном выполнении команды (`services/backend/src/telegram/outbox/telegram-opencode-runtime-bridge.service.ts`, `services/backend/src/telegram/outbox/tests/telegram-opencode-runtime-bridge.test.ts`). Проверить: при `ls -la && node count.js` в Telegram обновляется одна и та же карточка команды, без создания нового сообщения на каждом чанке.

1. 2026-02-12 - Доведена стабильность динамических terminal-progress сообщений в Telegram для `bash`: в runtime bridge ключ replace теперь вычисляется устойчиво даже если OpenCode не присылает `part.id` и меняет `callID` между апдейтами, поэтому новые чанки редактируют одно и то же сообщение вместо создания новых. Добавлен unit-тест на кейс без `part.id` и с меняющимся `callID` (`services/backend/src/telegram/outbox/telegram-opencode-runtime-bridge.service.ts`, `services/backend/src/telegram/outbox/tests/telegram-opencode-runtime-bridge.test.ts`). Проверить: при long-running команде в чате остается одна карточка `⏳ Выполняю команду`, а вывод внутри нее нарастает.

1. 2026-02-12 - Исправлена «зависающая» live-индикация выполнения bash-команд в Telegram: в `OutboxWorker` добавлен recovery-сценарий для ошибки Telegram `400: Bad Request: message can't be edited` — вместо бесконечных ретраев edit теперь бот отправляет новое progress-сообщение и перепривязывает `progressKey` к новому `message_id`, поэтому вывод терминала снова обновляется в реальном времени. Добавлены unit-тесты на fallback и на нерековерабельные ошибки (`services/bot/src/outbox-worker.ts`, `services/bot/src/tests/outbox-worker.test.ts`). Проверить: при длительной команде сообщение `⏳ Выполняю команду` продолжает обновляться; в outbox больше не накапливаются pending replace с ошибкой `message can't be edited`.

1. 2026-02-07 - Редактор настроек в Mini App переведен из inline-блока в полноэкранную модалку: при открытии файла (`Settings`) теперь показывается fullscreen editor с затемнением фона, закрытием по кнопке/ESC/клику вне окна, блокировкой прокрутки фона и отдельным footer с `Save`. Для этого расширен `CodeEditor` (поддержка кастомной высоты), обновлен `SettingsTab` и стили темы/адаптива. Файлы: `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/CodeEditor.tsx`, `services/miniapp/src/theme-layout.css`, тесты `services/miniapp/src/components/tests/settings-tab.test.tsx`. Проверить: клик по env-файлу открывает редактор во весь экран, `Save` работает, `Закрыть`/`Esc` закрывают модалку.

1. 2026-02-07 - Реализован автопоиск env-файлов внутри выбранного проекта и вывод списка в Mini App Settings: backend теперь сканирует проект с ограничениями (ignore для `.git/node_modules/...`, maxDepth/maxResults), возвращает `projectEnvFiles` в `settings/overview` и разрешает read/save для `projectEnvFile` только по найденным env-путям (защита от доступа к произвольным файлам). UI в `7. Настройки проекта` показывает список найденных env-файлов и открывает их в редакторе по клику. Файлы: `services/backend/src/projects/project-env-discovery.ts`, `services/backend/src/opencode/opencode-settings.service.ts`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/types.ts`, тесты `services/backend/src/opencode/tests/opencode-settings.service.test.ts`, `services/miniapp/src/components/tests/settings-tab.test.tsx`. Проверить: в проекте с несколькими `.env*`/`*.env` файлы появляются списком в Settings и открываются, `package.json` через `projectEnvFile` не читается.

1. 2026-02-07 - В Settings Mini App добавлено редактирование проектного `.env` как отдельного пункта в аккордионе `7. Настройки проекта` (кнопки `Project .env` и `Создать .env`), реализовано через расширение OpenCode settings API (`kind=projectEnv`) и обновление overview (`projectEnv`) для корректного отображения наличия файла. Файлы: `services/backend/src/opencode/opencode-settings.service.ts`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/types.ts`, тест `services/miniapp/src/components/tests/settings-tab.test.tsx`. Проверить: выбрать проект → открыть Settings → `Project .env` открывает editor, `Создать .env` создает файл в корне проекта.

1. 2026-02-07 - Добавлены Telegram-уведомления о запуске/остановке/перезапуске контейнеров из Mini App со списком контейнеров и их состояний: `ProjectsController` публикует event `project.lifecycle` после start/stop/restart и after per-service action, а `TelegramEventsOutboxBridge` доставляет его в чат админа даже при выключенном stream (`enqueueAdminNotification`). Файлы: `services/backend/src/projects/projects.controller.ts`, `services/backend/src/telegram/outbox/telegram-events-outbox-bridge.service.ts`, `services/backend/src/telegram/outbox/telegram-outbox.service.ts`, тест `services/backend/src/telegram/outbox/tests/telegram-events-outbox-bridge.test.ts`. Проверить: нажать Start/Restart/Stop в Mini App → в Telegram приходит список контейнеров со статусами.

1. 2026-02-07 - Для перехода на cross-platform хранение состояния OpenCode в Docker volume добавлена документация и скрипт миграции legacy host-папки `opencode-data` в volume `opencode_data`: `docs/VOLUME_MIGRATION.md`, `scripts/migrate-opencode-data-to-volume.sh`. Проверить: при наличии старой папки выполнить скрипт, после `docker compose up -d` история OpenCode сохраняется.

1. 2026-02-07 - Переведено хранение состояния OpenCode (проекты/сессии/сообщения) с bind-mount `./opencode-data` на Docker named volume `opencode_data` для кросс-платформенной установки (Windows/macOS/Linux) и чтобы данные не создавались в корне репозитория: обновлены `docker-compose.yml` и `docker-compose.dev.yml` (общий volume `opencode_data` подключен к `opencode:/root/.local/share/opencode` и `backend:/opencode-data`), в `.env.example` обновлено описание хранения state, в `docs/DATA_STORAGE.md` добавлено пояснение. Проверить: при `docker compose up -d` папка `opencode-data/` в корне репозитория не создается, OpenCode сохраняет состояние в volume `opencode_data`, backend sync по-прежнему работает.

1. 2026-02-07 - Добавлена автоочистка backend-хранилища `data/`, чтобы JSON-файлы и generated override-артефакты не разрастались бесконечно: реализован периодический maintenance-сервис `services/backend/src/maintenance/data-maintenance.service.ts` (prune outbox/diff-preview, удаление stale admin записей и stale slug, чистка `projects.json` по отсутствующим папкам, удаление `data/overrides/*.override.yml` для удаленных проектов) и добавлены методы prune в сторах (`services/backend/src/telegram/outbox/telegram-outbox.store.ts`, `services/backend/src/telegram/diff-preview/telegram-diff-preview.store.ts`, `services/backend/src/telegram/preferences/telegram-preferences.store.ts`, `services/backend/src/telegram/telegram-stream.store.ts`, `services/backend/src/projects/active-project.store.ts`, `services/backend/src/projects/project-state.store.ts`, `services/backend/src/projects/project-registry.ts`). Добавлена документация `docs/DATA_STORAGE.md` и unit-тесты ретеншена (`services/backend/src/maintenance/tests/data-maintenance.service.test.ts`, обновлен `services/backend/src/telegram/outbox/tests/telegram-outbox.store.test.ts`). Проверить: размер `telegram.outbox.json` не растет бесконечно, `telegram.diff-previews.json` очищается по TTL/лимиту, `projects.state.json` и `data/overrides` не содержат записей для удаленных проектов.

1. 2026-02-06 - Исправлена навигация во вкладке `Files`: кнопка перехода на уровень выше (`Go up`) теперь неактивна в корне выбранного проекта (пустой путь/`/`) и активна только во вложенных директориях. Добавлен UI-тест на оба сценария (`services/miniapp/src/components/tests/files-tab.test.tsx`) и обновлена логика вычисления доступности кнопки в `services/miniapp/src/components/FilesTab.tsx`. Проверить: при пути `/` кнопка `↑` disabled, при пути вроде `src/components` кнопка активна.

1. 2026-02-06 - Исправлена инфраструктурная конфигурация окружения: `OPENCODE_DATA_DIR` переключен с чужого пути `.../tvoc/opencode-data` на проектный `.../remote-vibe-station/opencode-data`, в `docker-compose.dev.yml` backend-публикация порта изменена с `3000:3000` на `${BACKEND_HOST_PORT:-3010}:3000`, в `.env` добавлен `BACKEND_HOST_PORT=3010`, в `.env.example` добавлена документация новой переменной, а fallback URL miniapp dev-сервера обновлен на `http://localhost:3010` (`services/miniapp/vite.config.ts`). Проверить: backend доступен по `http://localhost:3010/api/projects`, порт 3000 на хосте не слушается, `docker inspect` показывает bind на `.../remote-vibe-station/opencode-data`.

1. 2026-02-06 - Перенесено runtime-хранилище backend из bind-mount `./data` в Docker named volume `backend_data`, чтобы в корне репозитория оставались только исходники: обновлены `docker-compose.dev.yml` и `docker-compose.yml` (backend `volumes: backend_data:/app/data`, добавлен top-level volume `backend_data`), пересоздан backend-контейнер с новым mount и удалена локальная папка `data/` из репозитория. Проверить: `docker inspect remote-vibe-station-backend-1` показывает `Type=volume` для `/app/data`, и в корне проекта нет `data/`.

1. 2026-02-06 - Обновлен UX Telegram-ответов и кнопки режима: техническая строка footer теперь помечается markdown-цитатой и после рендера в Telegram показывается как `blockquote`, а reply-кнопка режима перешла на формат `⚙️ Режим | <active-project-slug>` вместо runtime-footer. Для этого обновлены форматтеры/рендерер и bot worker (`services/backend/src/telegram/outbox/telegram-footer.ts`, `services/backend/src/telegram/outbox/telegram-markdown.ts`, `services/backend/src/telegram/outbox/tests/telegram-footer.test.ts`, `services/backend/src/telegram/outbox/tests/telegram-markdown.test.ts`, `services/bot/src/mode-control.ts`, `services/bot/src/outbox-worker.ts`, `services/bot/src/tests/mode-control.test.ts`, `docs/OPENCODE_TELEGRAM_PLAN.md`). Проверить: в Telegram нижняя техстрока финального ответа отображается отдельной цитатой, а кнопка внизу чата выглядит как `⚙️ Режим | aihub` (или текущий slug проекта).

1. 2026-02-06 - В раздел `8. Общие настройки` добавлена кнопка `Перезагрузить OpenCode` для применения изменений правил/конфига без ручного доступа к Docker. На backend добавлен endpoint `POST /api/opencode/restart`, который находит контейнер(ы) с label `com.docker.compose.service=opencode` и выполняет `docker restart`; на frontend кнопка вызывает этот endpoint и затем обновляет overview настроек. Файлы: `services/backend/src/opencode/opencode-runtime.service.ts`, `services/backend/src/opencode/opencode.controller.ts`, `services/backend/src/app.module.ts`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/WorkspaceTabsContent.tsx`, `services/miniapp/src/App.tsx`. Проверить: после редактирования правил в Settings нажать `Перезагрузить OpenCode`, контейнер opencode перезапускается, API продолжает отвечать.

1. 2026-02-06 - Реализовано управление созданием и удалением проектов из Mini App: во вкладке `Projects` поиск переработан в layout 80/20 (поле поиска + кнопка `+`), добавлено меню создания с двумя сценариями — `Создать папку проекта` (ввод имени) и `Клонировать git репозиторий` (URL + опциональная папка, с использованием git credentials backend runtime/container). На backend добавлены API `POST /api/projects/create-folder`, `POST /api/projects/clone`, `POST /api/projects/:id/delete` с валидацией путей/имен; удаление блокируется для git-репозиториев с незакоммиченными изменениями (`git status --porcelain`). В `Settings` добавлен аккордеон `Настройки проекта` с кнопкой удаления выбранного проекта и предупреждением о блокировке при dirty git state. Также добавлена автоочистка stale active selection, если выбранный проект физически удален. Файлы: `services/backend/src/projects/project-workspace.service.ts`, `services/backend/src/projects/project-workspace.utils.ts`, `services/backend/src/projects/projects.controller.ts`, `services/backend/src/projects/projects.service.ts`, `services/backend/src/app.module.ts`, тест `services/backend/src/projects/tests/project-workspace.utils.test.ts`; `services/miniapp/src/components/ProjectsTab.tsx`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/WorkspaceTabsContent.tsx`, `services/miniapp/src/hooks/use-project-workspace.ts`, `services/miniapp/src/App.tsx`, `services/miniapp/src/styles.css`, `services/miniapp/src/theme-layout.css`, обновлены тесты `services/miniapp/src/components/tests/projects-tab.test.tsx`, `services/miniapp/src/components/tests/settings-tab.test.tsx`. Проверить: кнопка `+` показывает два сценария создания, clone/create обновляют список проектов, удаление активного проекта работает только для clean/non-git папок.

1. 2026-02-06 - Переведено хранение глобальных OpenCode настроек на Docker-native схему (container source-of-truth): добавлен общий named volume `opencode_config` и подключен одновременно к `opencode` (`/root/.config/opencode`) и `backend` (`/opencode-config`), backend теперь читает/создает/редактирует `AGENTS.md`, `opencode.json`, `agents/skills/plugins` именно из этого контейнерного хранилища через `OPENCODE_CONFIG_DIR=/opencode-config`. Обновлены compose-файлы dev/prod и backend config (`OPENCODE_CONFIG_DIR` в schema/types), а в сервисе настроек убран хостовый fallback на `~/.config/opencode` в пользу контейнерного пути по умолчанию. Файлы: `docker-compose.dev.yml`, `docker-compose.yml`, `services/backend/src/config/config.types.ts`, `services/backend/src/config/config.ts`, `services/backend/src/opencode/opencode-settings.service.ts`, `.env.example`. Проверить: `GET /api/opencode/settings/overview` возвращает пути `/opencode-config/...`, созданные через miniapp файлы сразу видны внутри `opencode` контейнера в `/root/.config/opencode`.

1. 2026-02-06 - В `Settings` реализован аккордеон с подразделами OpenCode и встроенным редактором файлов для мобильного miniapp: добавлены секции `Правила агента`, `Агенты`, `Конфиг OpenCode`, `Commands`, `Skills`, `Plugins`, `Общие настройки`; для `AGENTS.md` (глобальный и проектный) и `opencode.json` поддержаны сценарии create/read/edit/save, для списков (`agents/commands/skills/plugins`) реализованы листинг файлов, открытие, создание файла по имени (с расширением) и сохранение содержимого. На backend добавлен API `GET /api/opencode/settings/overview` и `POST /api/opencode/settings/{read|save|create}` с безопасным резолвом путей и защитой от traversal; команды проекта берутся из `<project>/.opencode/commands`, глобальные разделы — из `OPENCODE_CONFIG_DIR` или `~/.config/opencode`. Для удобного редактирования подключен CodeMirror (`@uiw/react-codemirror` + markdown/json language packs). Файлы: `services/backend/src/opencode/opencode-settings.service.ts`, `services/backend/src/opencode/opencode.controller.ts`, `services/backend/src/app.module.ts`; `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/CodeEditor.tsx`, `services/miniapp/src/hooks/use-opencode-settings.ts`, `services/miniapp/src/components/WorkspaceTabsContent.tsx`, `services/miniapp/src/App.tsx`, `services/miniapp/src/theme-layout.css`, `services/miniapp/src/types.ts`, `services/miniapp/package.json`. Проверить: в Settings открываются все аккордеоны, файлы читаются/создаются/сохраняются, синхронизация OpenCode и переключение day/night находятся в `Общие настройки`.

1. 2026-02-06 - Добавлен полноценный раздел `GitHub` в Mini App с базовым управлением git: новая вкладка в верхнем меню (после `Files`), обзор текущей ветки и ahead/behind, список измененных файлов со статусами (`modified/added/deleted/renamed/untracked/conflict`) и line stats, а также операции `refresh/fetch/pull/push/switch/merge/commit`. На backend реализованы новые endpoint-ы `GET /api/projects/:id/git/overview`, `POST /api/projects/:id/git/{fetch|pull|push|checkout|merge|commit}` и выделены сервисы `ProjectGitOpsService`/парсеры статусов; на фронте добавлены `GitHubTab`, `useProjectGit`, мобильные стили и интеграция в tab-router. Дополнительно исправлено отображение git-статистики через установку `git` в backend-контейнер и безопасный `safe.directory` override для volume-репозиториев. Файлы: `services/backend/src/projects/project-git-ops.service.ts`, `services/backend/src/projects/git-overview-parser.ts`, `services/backend/src/projects/projects.controller.ts`, `services/backend/src/projects/projects.service.ts`, `services/backend/src/projects/project-git.service.ts`, `services/backend/src/projects/project.types.ts`, `services/backend/src/app.module.ts`, `services/backend/Dockerfile`; `services/miniapp/src/components/GitHubTab.tsx`, `services/miniapp/src/components/WorkspaceHeader.tsx`, `services/miniapp/src/components/WorkspaceTabsContent.tsx`, `services/miniapp/src/hooks/use-project-git.ts`, `services/miniapp/src/types.ts`, `services/miniapp/src/App.tsx`, `services/miniapp/src/git-tab.css`, `services/miniapp/src/main.tsx`, `services/miniapp/src/workspace-header.css`, `services/miniapp/src/api/client.ts`. Тесты: `services/backend/src/projects/tests/git-overview-parser.test.ts`, `services/miniapp/src/components/tests/github-tab.test.tsx`, обновлены `services/miniapp/src/components/tests/workspace-header.test.tsx` и смежные тесты. Проверить: после выбора проекта доступна вкладка GitHub, операции выполняются и обновляют список файлов/ветку, карточки проектов показывают git-дельты, файлы >500 строк удержаны ниже лимита.

1. 2026-02-06 - Исправлено отсутствие git-статистики в карточках проектов: в backend-контейнер добавлен `git` (`services/backend/Dockerfile`), а git-команды переведены на inline-параметр `-c safe.directory=<projectRoot>` без изменения глобального git config (устранена ошибка `detected dubious ownership` в Docker volume). Файл: `services/backend/src/projects/project-git.service.ts`. Проверить: `GET /api/projects/<id>/git-summary` возвращает JSON с `filesChanged/additions/deletions`, и в Mini App отображаются `+/-` и число файлов.

1. 2026-02-06 - Упрощена вкладка `Projects` и добавлена dev-метрика изменений: удалены фильтр `Runnable only` и кнопки `Refresh/Sync OpenCode/Warm Recents`, оставлена только строка поиска и выбор проекта; управление Docker полностью убрано из карточек проектов (оставлена только `Select/Selected`), а вместо старого статуса добавлены (а) индикатор контейнеров с цветом и форматами `N` или `N/M`, (б) git-сводка незакомиченных изменений `+additions -deletions filesChanged`. Для этого добавлен backend endpoint `GET /api/projects/:id/git-summary` с парсингом `git status --porcelain` и `git diff --numstat`, плюс исправлена нормализация compose project name для slug с точкой (`do-invest.ru`), чтобы status endpoint не падал. Файлы: `services/miniapp/src/components/ProjectsTab.tsx`, `services/miniapp/src/App.tsx`, `services/miniapp/src/styles.css`, `services/miniapp/src/theme-layout.css`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/utils/project-metadata.ts`, `services/miniapp/src/utils/project-container-health.ts`, `services/miniapp/src/types.ts`, тесты `services/miniapp/src/components/tests/projects-tab.test.tsx`, `services/miniapp/src/components/tests/settings-tab.test.tsx`, `services/miniapp/src/utils/tests/project-container-health.test.ts`; backend `services/backend/src/projects/projects.controller.ts`, `services/backend/src/projects/projects.service.ts`, `services/backend/src/projects/project-git.service.ts`, `services/backend/src/projects/git-summary-parser.ts`, `services/backend/src/projects/project.types.ts`, `services/backend/src/app.module.ts`, тест `services/backend/src/projects/tests/git-summary-parser.test.ts`. Проверить: в карточках проектов нет Start/Restart/Stop, есть только Select/Selected; есть контейнерный индикатор и git-сводка; для slug с точкой status больше не дает 400.

1. 2026-02-06 - Устранены артефакты «битой кодировки» в терминале Mini App: проблема была не в UTF-8, а в выводе управляющих ANSI-последовательностей PTY (например `ESC[?2004h` для bracketed paste), которые показывались как мусор в plain-text `<pre>`. Добавлена санитаризация terminal chunk перед рендером (удаление ANSI CSI/OSC и непечатаемых control-символов) и тесты на очистку escape-последовательностей/цветов. Файлы: `services/miniapp/src/hooks/use-terminal-events.ts`, `services/miniapp/src/utils/terminal-output.ts`, `services/miniapp/src/utils/tests/terminal-output.test.ts`. Проверить: в Terminal больше не появляется префикс вида `�[?2004h`, приглашение shell и вывод команд читаются без служебного мусора.

1. 2026-02-06 - Переделан верхний блок Mini App в иконковое таб-меню: удален заголовок `Workspace` и текстовые табы, добавлена верхняя панель из 5 равных icon-only кнопок (`projects/files/terminal/containers/settings`) с переносом навигации в самый верх экрана, а активный проект переработан в отдельную карточку-блок с улучшенной визуальной подачей и stream-toggle. Файлы: `services/miniapp/src/components/WorkspaceHeader.tsx`, `services/miniapp/src/workspace-header.css`, `services/miniapp/src/main.tsx`, тест `services/miniapp/src/components/tests/workspace-header.test.tsx`. Проверить: вверху только 5 иконок без названий, старые текстовые табы отсутствуют, карточка выбранного проекта выглядит как выделенный блок и корректно отображается на mobile/desktop.

1. 2026-02-06 - Улучшено управление контейнерами во вкладке `Containers`: текстовые кнопки `Start/Restart/Stop` заменены на компактные icon-only кнопки с hover-эффектами и понятными tooltip/aria-label, добавлены иконки для compose-операций и операций каждого контейнера, а на backend добавлен fallback-вывод `service` из имени контейнера (`<project>-<service>-<index>`), чтобы кнопки действий не блокировались при отсутствии поля `Service` в выводе Docker. Файлы: `services/miniapp/src/components/ContainersTab.tsx`, `services/miniapp/src/containers-layout.css`, `services/backend/src/projects/projects.service.ts`. Проверить: в `Containers` отображаются иконки вместо слов, кнопки активны для контейнеров `tvoc-*`, управление работает для всего compose и по каждому контейнеру отдельно.

1. 2026-02-06 - Обновлен UI Mini App и исправлен контейнерный статус: добавлен новый таб `Settings` после `Containers` с переключением day/night темы, управление стримом перенесено к названию активного проекта в виде иконки-переключателя, в файловом тулбаре `Up/Refresh` переведены в компактные icon-only кнопки, терминал переверстан на full-height режим с нижней строкой ввода в стиле мессенджера (min-height 300), а на backend исправлен парсинг `docker compose ps --format json` (поддержка warning+NDJSON и нормализация полей в стабильный API ответ). Файлы: `services/miniapp/src/App.tsx`, `services/miniapp/src/components/WorkspaceHeader.tsx`, `services/miniapp/src/components/SettingsTab.tsx`, `services/miniapp/src/components/FilesTab.tsx`, `services/miniapp/src/components/TerminalTab.tsx`, `services/miniapp/src/components/ContainersTab.tsx`, `services/miniapp/src/utils/theme.ts`, `services/miniapp/src/theme-layout.css`, `services/miniapp/src/main.tsx`, `services/backend/src/projects/docker-compose-ps-parser.ts`, `services/backend/src/projects/projects.service.ts`, тесты `services/miniapp/src/utils/tests/theme.test.ts`, `services/backend/src/projects/tests/docker-compose-ps-parser.test.ts`. Проверить: в Mini App появился таб Settings, тема переключается и сохраняется, stream-toggle рядом с названием проекта, файловые кнопки иконками, терминал занимает всю доступную высоту, вкладка Containers больше не падает с parse error.

1. 2026-02-06 - Настроен hot reload для Mini App в dev-стеке Docker: `docker-compose.dev.yml` переведен на Vite dev server с bind-mount исходников и polling watcher (без пересборки образа при каждом изменении), добавлен proxy `/api` и `/events` на backend в `services/miniapp/vite.config.ts`, добавлена инструкция запуска в `README.md`. Файлы: `docker-compose.dev.yml`, `services/miniapp/vite.config.ts`, `README.md`. Проверить: при `docker compose -f docker-compose.dev.yml up -d` изменения в `services/miniapp/src/*` появляются в браузере сразу без `docker compose build`, а API работает без 404.

1. 2026-02-06 - Обновлен верхний layout Mini App под edge-to-edge: удален отдельный хедер `OpenCode Control`, убраны внешние отступы контейнера, выключены серый фон/градиенты и карточный стиль панели (border-radius/shadow), чтобы белый рабочий блок прилегал к границам экрана (`services/miniapp/src/App.tsx`, `services/miniapp/src/styles.css`). Проверить: в Mini App нет верхнего заголовка, белый блок начинается от краев экрана и серый фон отсутствует на desktop и mobile.

1. 2026-02-06 - Реализован deep-link preview diff из Telegram-сообщения о файловых изменениях: формат runtime-сообщения изменен на HTML (курсив операции, жирные `+N/-M`, жирная подчеркнутая кликабельная ссылка на путь), добавлен token-store diff preview и endpoint `GET /api/telegram/diff-preview/:token`, а Mini App научен открывать полноэкранный просмотр diff по `startapp=diff_<token>` (`services/backend/src/telegram/outbox/telegram-file-event-message.ts`, `services/backend/src/telegram/outbox/telegram-opencode-runtime-bridge.service.ts`, `services/backend/src/telegram/diff-preview/telegram-diff-preview.store.ts`, `services/backend/src/telegram/telegram.controller.ts`, `services/miniapp/src/MiniAppRoot.tsx`, `services/miniapp/src/components/DiffPreviewScreen.tsx`, `services/miniapp/src/utils/start-param.ts`, `services/miniapp/src/diff-preview.css`). Проверить: клик по пути файла в Telegram открывает Mini App и полноэкранный diff нужного файла.
1. 2026-02-06 - Исправлено форматирование markdown-кода в Telegram-ответах: fenced блоки ```...``` и inline `code` конвертируются в Telegram HTML (`<pre><code>` / `<code>`), чтобы не показывать сырые обратные кавычки (`services/backend/src/telegram/outbox/telegram-markdown.ts`, `services/backend/src/telegram/outbox/telegram-outbox.service.ts`, `services/backend/src/telegram/outbox/tests/telegram-markdown.test.ts`). Проверить: в новых ответах код отображается как форматированный блок без символов ```.
1. 2026-02-06 - Исправлен индикатор размышления: теперь он управляется runtime-событиями OpenCode и появляется при `reasoning`, скрывается при `tool/text/idle`, затем может повторно появляться после tool-этапов при возврате к размышлению (`services/backend/src/telegram/outbox/telegram-opencode-runtime-bridge.service.ts`, `services/backend/src/telegram/outbox/telegram-outbox.service.ts`, `services/backend/src/telegram/outbox/telegram-outbox.types.ts`, `services/backend/src/telegram/outbox/telegram-outbox.store.ts`, `services/bot/src/outbox-worker.ts`). Проверить: в одном запросе индикатор может несколько раз появляться/исчезать по фазам работы агента.
2. 2026-02-06 - Перенастроена политика уведомлений: промежуточные и технические сообщения outbox отправляются тихо (`disable_notification=true`), звуковое уведомление приходит только на финальном чанке ответа (без отдельного mention-пинга) (`services/backend/src/telegram/outbox/telegram-outbox.types.ts`, `services/backend/src/telegram/outbox/telegram-outbox.store.ts`, `services/backend/src/telegram/outbox/telegram-outbox.service.ts`, `services/bot/src/outbox-worker.ts`). Проверить: во время выполнения нет звука, в конце один обычный audible финальный ответ.
1. 2026-02-05 - Добавлены расширенные runtime-события OpenCode для Telegram: форматирование операций с файлами (`Создание/Редактирование/Удаление ... +N -M`), live-обновление выполнения `bash` в одном сообщении через replace/edit и поддержка вопросов OpenCode с inline-кнопками и обратной отправкой ответа в OpenCode (`services/backend/src/telegram/outbox/telegram-opencode-runtime-bridge.service.ts`, `services/backend/src/open-code/opencode-session-routing.store.ts`, `services/backend/src/telegram/telegram.controller.ts`, `services/backend/src/open-code/opencode-client.ts`, `services/backend/src/open-code/opencode-telemetry.ts`, `services/backend/src/telegram/outbox/*`, `services/bot/src/outbox-worker.ts`, `services/bot/src/main.ts`). Проверить: во время выполнения команд видно live-прогресс терминала, события изменения файлов приходят отдельными строками, вопросы OpenCode приходят с inline-кнопками и корректно принимают ответ.
2. 2026-02-05 - Исправлен footer в Telegram-ответах: вместо дублирования агента теперь выводится `thinking | agent` (данные thinking проброшены из prompt-события в outbox) в `services/backend/src/prompt/prompt.service.ts`, `services/backend/src/telegram/outbox/telegram-events-outbox-bridge.service.ts`, `services/backend/src/telegram/outbox/telegram-outbox.service.ts`, `services/backend/src/telegram/outbox/telegram-footer.ts`; добавлен тест `services/backend/src/telegram/outbox/tests/telegram-footer.test.ts`. Проверить: в нижней строке ответа отображается степень мышления (например `high/default`) и имя агента.
3. 2026-02-05 - Полностью реализовано Telegram-меню режима (модель/степень мышления/агент): добавлены backend настройки и валидация (`services/backend/src/telegram/preferences/*`, `services/backend/src/telegram/telegram.controller.ts`, `services/backend/src/open-code/opencode-client.ts`, `services/backend/src/open-code/opencode.types.ts`, `services/backend/src/prompt/prompt.service.ts`, `services/backend/src/app.module.ts`), а также bot UX с reply-кнопкой `⚙️ Режим`, `/mode` и inline picker (`services/bot/src/mode-control.ts`, `services/bot/src/mode-callback.ts`, `services/bot/src/main.ts`, `services/bot/src/telegram-commands.ts`). Добавлены тесты (`services/backend/src/telegram/preferences/tests/telegram-preferences.store.test.ts`, `services/backend/src/open-code/tests/opencode-client.test.ts`, `services/bot/src/tests/mode-callback.test.ts`). Проверить: в Telegram доступно меню `⚙️ Режим`, выбор model/thinking/agent сохраняется и влияет на новые промпты.
4. 2026-02-05 - Добавлен периодический ресинк slash-меню Telegram (каждые 60с) для OpenCode-команд: создан планировщик `services/bot/src/command-sync.ts`, интегрирован lifecycle start/stop в `services/bot/src/main.ts`, добавлены тесты `services/bot/src/tests/command-sync.test.ts`. Проверить: после изменения команд в OpenCode меню Telegram обновляется без ручного `/start`.
5. 2026-02-05 - Реализован проброс slash-команд OpenCode в Telegram: backend добавил `GET /api/telegram/commands` и `POST /api/telegram/command` (`services/backend/src/telegram/telegram.controller.ts`, `services/backend/src/prompt/prompt.service.ts`, `services/backend/src/open-code/opencode-client.ts`, `services/backend/src/open-code/opencode.types.ts`), bot синхронизирует меню `setMyCommands` и выполняет неизвестные локальному боту slash-команды через backend (`services/bot/src/main.ts`, `services/bot/src/telegram-commands.ts`). Добавлены тесты для маппинга/парсинга команд и API-клиента (`services/bot/src/tests/telegram-commands.test.ts`, `services/backend/src/open-code/tests/opencode-client.test.ts`). Проверить: в Telegram при вводе `/` видны команды OpenCode + `/start` + команды стрима; `/help` (или другая команда OpenCode) исполняется и ответ приходит через outbox.
6. 2026-02-05 - Добавлена надежная доставка сообщений в Telegram: backend outbox (`services/backend/src/telegram/outbox/*`, `data/telegram.outbox.json`) + polling worker в боте (`services/bot/src/outbox-worker.ts`) с lease+retry; добавлен футер в конце ответа (контекст/%, provider/model, mode, agent) и компактный trace (tool/patch/subtask) без chain-of-thought; добавлен "thinking" индикатор со спиннером в Telegram и авто-удаление перед доставкой outbox (`services/bot/src/thinking-indicator.ts`). Проверить: при долгом ответе виден спиннер, затем он удаляется и приходит ответ с футером.
7. 2026-02-05 - Обновлен "thinking" индикатор в Telegram: вместо спиннера теперь анимированные точки (обновление раз в 1с) в `services/bot/src/thinking-indicator.ts`. Проверить: во время выполнения промпта текст меняется `.` -> `..` -> `...` и индикатор удаляется перед ответом.
8. 2026-02-05 - Доведена Mini App часть до требований по стриму и лимитам файлов: стрим-индикатор (ярко-зеленый) на активном проекте и в блоке Workspace, скрытие/disable Select для уже выбранного проекта, вынос логики auth/WS/иконок в `services/miniapp/src/hooks/*` и `services/miniapp/src/utils/file-icons.tsx`, снижение `services/miniapp/src/App.tsx` до лимита 500 строк; актуализирована спецификация под текущее поведение в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: Start/Stop stream кнопки, STREAM badge на активной карточке проекта, вывод терминала по WS.
9. 2026-02-05 - Создан рабочий каркас проекта: backend (NestJS), bot (Telegraf), miniapp (Vite/React), opencode Dockerfile, Traefik конфиги и docker-compose build, плюс базовые тесты и шаблоны. Проверить: сборка сервисов, запуск docker compose, доступность /api и /miniapp.
10. 2026-02-05 - Добавлена полная спецификация, актуальные env-параметры и структура репозитория в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: соответствие файлов и конфигов.
11. 2026-02-04 - Создан каркас проекта (README, .env.example, docker-compose, Traefik конфиги, шаблоны проектов, сервисные README) и переписана полная спецификация в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: ссылки на файлы, placeholders, корректность маршрутизации.
12. 2026-02-04 - Добавлены шаблоны конфигураций (env, docker-compose, Traefik, override проекта) и детализирован механизм поддоменов/запуска проектов в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: валидность шаблонов, placeholders для портов/домена.
13. 2026-02-04 - Добавлена детальная инструкция развертывания VPS, управление проектами через Docker Compose, поддомены проектов через Traefik и noindex-настройки в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: DNS wildcard, Traefik routing, docker.sock доступ, запуск/статусы проектов.
14. 2026-02-04 - Зафиксировано ограничение масштаба (1 сервер -> 1 OpenCode -> 1 Telegram) и текущий минимальный сценарий удаленного подключения в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: формулировки 1:1:1 и приоритеты.
15. 2026-02-04 - Добавлено описание серверного и клиентского режимов OpenCode, а также привязка к нашей схеме (server mode в Docker, SSE `/event`, Basic Auth при внешнем доступе) в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: запуск `opencode serve`, доступность `/doc` и `/event` внутри сети.
16. 2026-02-04 - Обновлен план Telegram-управления (чат + Mini App, удаленный доступ через reverse proxy, безопасность, API, Docker Compose) в `docs/OPENCODE_TELEGRAM_PLAN.md`; файл перенесен в `docs/OPENCODE_TELEGRAM_PLAN.md`. Проверить: домен и TLS, маршруты proxy, соответствие endpoint-ов и событий.
