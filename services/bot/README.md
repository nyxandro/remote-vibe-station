# Telegram Bot

Чат-интерфейс для управления OpenCode и выдачи безопасного web-доступа.

## Основные обязанности

- Получать промпты от администратора и отправлять их в backend.
- Доставлять поток ответов и событий через outbox.
- Обрабатывать локальные команды (`/start`, `/open`, `/mode`, `/chat`, `/end`, `/project`, `/sessions`, `/repair`).
- Выдавать одноразовую ссылку `/access` для входа во внешний OpenCode UI (только для администраторов из `ADMIN_IDS`).

## Безопасность доступа к OpenCode UI

- `/access` доступна только пользователям из `ADMIN_IDS`.
- Команда генерирует одноразовую ссылку (TTL 5 минут).
- После перехода ставится защищенная cookie-сессия (TTL 30 дней для режима "доверенное админ-устройство").
- Параметры cookie: `HttpOnly=true`, `Secure=true`, `SameSite=Strict`, `Path=/`, `Domain=<OPENCODE_PUBLIC_DOMAIN>`, `Max-Age=2592000`.
- Проверка сессии выполняется через Traefik `forwardAuth` endpoint `/opencode-auth/check`.

## Отзыв сессий

- Текущее хранение сессий: `services/bot/src/opencode-web-auth.ts` (`/app/data/opencode-web-auth.json`).
- Для экстренного отзыва всех сессий достаточно удалить файл состояния и перезапустить bot-контейнер.
- При изменении `ADMIN_IDS` рекомендуется очистить файл состояния, чтобы принудительно завершить ранее выданные cookie-сессии.
